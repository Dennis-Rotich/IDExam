<!DOCTYPE html>
<html>
<head>
    <title>Teacher Dashboard</title>
    <style>
        .student-card { 
            border: 1px solid #333; margin: 10px; padding: 10px; 
            width: 300px; float: left; background: #f9f9f9; 
        }
        .student-code { 
            width: 100%; height: 150px; background: #222; 
            color: #0f0; border: none; font-family: monospace; 
        }
    </style>
    <script>var module = {};</script>

    <script src="https://unpkg.com/fast-diff/diff.js"></script>
    
    <script>var diff = module.exports;</script>
    
    <script src="/socket.io/socket.io.js"></script>
</head>
<body>
    <h2>Exam Proctor Dashboard</h2>
    <div id="grid"></div>
    <script src="/socket.io/socket.io.js"></script>
    <script>
    const socket = io();
    const grid = document.getElementById('grid');
    
    // We store the current text state for each student
    const studentStates = {};

    socket.on('connect', () => {
        socket.emit('join_exam', 'teacher');
    });

    socket.on('student_joined', (id) => {
        createStudentCard(id);
    });

    // 1. Handle Delta Updates
    socket.on('student_delta', (data) => {
        const { studentId, changes } = data;
        
        // Ensure student card exists
        createStudentCard(studentId);
        
        // Retrieve current text (or empty string if new)
        let currentText = studentStates[studentId] || "";
        
        // Apply changes to reconstruct the new text
        let newText = "";
        let cursor = 0;

        // Iterate through the diff array: [ [mode, text], ... ]
        // mode: 0 = equal (keep), 1 = insert, -1 = delete
        changes.forEach(([mode, text]) => {
            if (mode === 0) {
                // Keep: Take characters from the current text
                // Since 'fast-diff' returns the text segment, we just append it
                newText += text;
            } else if (mode === 1) {
                // Insert: Add the new text
                newText += text;
            } 
            // Delete (-1): We simply ignore the text from the old string, effectively deleting it
        });

        // Update State
        studentStates[studentId] = newText;
        updateView(studentId, newText);
    });

    // 2. Handle Full Sync (Safety Net)
    socket.on('student_full_sync', (data) => {
        const { studentId, code } = data;
        createStudentCard(studentId);
        studentStates[studentId] = code; // Hard overwrite
        updateView(studentId, code);
    });

    function createStudentCard(id) {
        if (document.getElementById(`card-${id}`)) return;
        
        // Initialize state
        studentStates[id] = "";

        const div = document.createElement('div');
        div.className = 'student-card';
        div.id = `card-${id}`;
        div.innerHTML = `
            <h4>${id.substr(0,4)}</h4>
            <textarea id="code-${id}" class="student-code" readonly></textarea>
        `;
        grid.appendChild(div);
    }

    function updateView(id, text) {
        const textarea = document.getElementById(`code-${id}`);
        if (textarea) {
            textarea.value = text;
            // Scroll to bottom to follow updates (optional)
            textarea.scrollTop = textarea.scrollHeight;
        }
    }
    </script>
</body>
</html>